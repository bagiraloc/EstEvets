<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDBXt2gMo92d6MpzxdzEvLI8UMcyHipVTg",
    authDomain: "estevents.firebaseapp.com",
    databaseURL: "https://estevents-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "estevents",
    storageBucket: "estevents.firebasestorage.app",
    messagingSenderId: "227576344701",
    appId: "1:227576344701:web:adf679a530b4ce72d5c114",
    measurementId: "G-3ZDEP57KXF"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let lastAdded = null;

  // --- Ğ°Ğ²Ñ‚Ğ¾Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ· Google Sheets ---
  const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSiLPa8xQDMN2XwhllLfVcFo_fjbLYVU0nQ6iSVTaAJezovC8OYgSgTOqiz-muYLNnYAtgJhqpZwhPK/pub?gid=910619786&single=true&output=csv";

  let lastData = ""; // Ğ·Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ” Ğ¿Ğ¾Ğ¿ĞµÑ€ĞµĞ´Ğ½Ñ” Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ½Ñ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸

  async function fetchSheetData() {
    try {
      const res = await fetch(sheetURL);
      const text = await res.text();
      const rows = text.split("\n").map(r => r.split(","));
      const d7 = rows[6][3]?.trim(); // D7 - Ğ†Ğ¼â€™Ñ
      const e7 = rows[6][4]?.trim(); // E7 - ĞšĞ»ÑƒĞ±
      const g7 = rows[6][6]?.trim(); // G7 - Ğ’Ğ¸Ğ´
      const h7 = parseFloat(rows[6][7]?.replace(",", "."));
      if (!d7 || !e7 || !g7 || isNaN(h7)) return;

      const current = `${d7}|${e7}|${g7}|${h7}`;
      if (current === lastData) return; // ÑĞºÑ‰Ğ¾ Ğ´Ğ°Ğ½Ñ– Ñ‚Ñ– ÑĞ°Ğ¼Ñ– â€” Ğ½Ñ–Ñ‡Ğ¾Ğ³Ğ¾ Ğ½Ğµ Ñ€Ğ¾Ğ±Ğ¸Ğ¼Ğ¾
      lastData = current;

      const gymnastKey = d7.replace(/\s+/g, "_");
      const gymnastRef = ref(db, "gymnasts/" + gymnastKey);
      const snapshot = await new Promise(resolve => {
        onValue(gymnastRef, resolve, { onlyOnce: true });
      });

      let data = snapshot.val() || { name: d7, club: e7, obruÄ: 0, myach: 0, buÅ‚avy: 0, strichka: 0, suma: 0 };
      data[g7] = h7;
      data.suma = (data.obruÄ || 0) + (data.myach || 0) + (data.buÅ‚avy || 0) + (data.strichka || 0);
      await set(gymnastRef, data);

      lastAdded = gymnastKey;
    } catch (err) {
      console.error("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ñ‡Ğ¸Ñ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ–:", err);
    }
  }

  setInterval(fetchSheetData, 3000); // Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ ĞºĞ¾Ğ¶Ğ½Ñ– 3 ÑĞµĞºÑƒĞ½Ğ´Ğ¸

  // --- ĞºÑ–Ğ½ĞµÑ†ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ ---


  // Ğ”Ğ¾Ğ´Ğ°Ğ²Ğ°Ğ½Ğ½Ñ Ğ³Ñ–Ğ¼Ğ½Ğ°ÑÑ‚ĞºĞ¸ Ğ²Ñ€ÑƒÑ‡Ğ½Ñƒ
  window.addGymnast = async function() {
    const name = document.getElementById("name").value.trim();
    const club = document.getElementById("club").value.trim();
    const event = document.getElementById("event").value;
    const score = parseFloat(document.getElementById("score").value.replace(",", "."));

    if (!name || !club || !event || isNaN(score)) {
      alert("Ğ‘ÑƒĞ´ÑŒ Ğ»Ğ°ÑĞºĞ°, Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½Ñ–Ñ‚ÑŒ Ğ²ÑÑ– Ğ¿Ğ¾Ğ»Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾!");
      return;
    }

    const gymnastKey = name.replace(/\s+/g, "_");
    const gymnastRef = ref(db, "gymnasts/" + gymnastKey);
    const snapshot = await new Promise(resolve => {
      onValue(gymnastRef, resolve, { onlyOnce: true });
    });

    let data = snapshot.val() || { name, club, obruÄ: 0, myach: 0, buÅ‚avy: 0, strichka: 0, suma: 0 };
    data[event] = score;
    data.suma = (data.obruÄ || 0) + (data.myach || 0) + (data.buÅ‚avy || 0) + (data.strichka || 0);
    await set(gymnastRef, data);

    lastAdded = gymnastKey;

    document.getElementById("name").value = "";
    document.getElementById("club").value = "";
    document.getElementById("score").value = "";
  };

  // ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚Ğ¸ Ğ²ÑÑ– Ğ´Ğ°Ğ½Ñ–
  window.clearAll = async function() {
    if (confirm("Ğ’Ğ¸ Ğ²Ğ¿ĞµĞ²Ğ½ĞµĞ½Ñ–, Ñ‰Ğ¾ Ñ…Ğ¾Ñ‡ĞµÑ‚Ğµ Ğ¿Ğ¾Ğ²Ğ½Ñ–ÑÑ‚Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚Ğ¸Ñ‚Ğ¸ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ?")) {
      const gymnastsRef = ref(db, "gymnasts");
      await set(gymnastsRef, {});
      alert("Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ¾!");
    }
  };

  // Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ğ³Ñ–Ğ¼Ğ½Ğ°ÑÑ‚ĞºĞ¸
  window.deleteGymnast = async function(nameKey) {
    if (confirm("Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ " + nameKey.replace(/_/g, " ") + "?")) {
      const gymnastRef = ref(db, "gymnasts/" + nameKey);
      await remove(gymnastRef);
    }
  };

  // ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚Ğ¸/ÑÑ…Ğ¾Ğ²Ğ°Ñ‚Ğ¸ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
  window.togglePanel = function() {
    const panel = document.getElementById("editPanel");
    panel.classList.toggle("visible");
  };

  // Ğ’Ñ–Ğ´Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ–
  const tableBody = document.getElementById("gymnastTable");

  onValue(ref(db, "gymnasts"), snapshot => {
    const data = snapshot.val() || {};
    const arr = Object.entries(data)
      .map(([key, val]) => ({ key, ...val }))
      .sort((a, b) => b.suma - a.suma);

    tableBody.innerHTML = "";
    arr.forEach((g, i) => {
      const row = document.createElement("tr");
      const crown = i === 0 ? "ğŸ‘‘" : "";

      if (g.key === lastAdded) {
        row.classList.add("new-gymnast");
        setTimeout(() => row.classList.remove("new-gymnast"), 4000);
      }

      row.innerHTML = `
        <td>${i + 1}</td>
        <td class="${i === 0 ? 'shine' : ''}">${crown} ${g.name}</td>
        <td>${g.club}</td>
        <td>${g.obruÄ || "-"}</td>
        <td>${g.myach || "-"}</td>
        <td>${g.buÅ‚avy || "-"}</td>
        <td>${g.strichka || "-"}</td>
        <td><b>${g.suma.toFixed(3)}</b></td>
        <td><button class="delete-btn" onclick="deleteGymnast('${g.key}')">ğŸ</button></td>
      `;
      tableBody.appendChild(row);
    });

    const mainTable = document.getElementById("mainTable");
    const scale = Math.min(1, 10 / (arr.length / 6));
    mainTable.style.transform = `scale(${scale})`;
  });

  function createLeaf() {
    const leaf = document.createElement("div");
    leaf.classList.add("leaf");
    leaf.textContent = "ğŸ";
    leaf.style.left = Math.random() * 100 + "vw";
    leaf.style.animationDuration = 5 + Math.random() * 10 + "s";
    leaf.style.fontSize = 20 + Math.random() * 20 + "px";
    document.body.appendChild(leaf);
    setTimeout(() => leaf.remove(), 15000);
  }
  setInterval(createLeaf, 500);
</script>
