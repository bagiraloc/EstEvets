<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ó–æ–ª–æ—Ç–∞ –û—Å—ñ–Ω—å 2025 üçÅ</title>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDBXt2gMo92d6MpzxdzEvLI8UMcyHipVTg",
      authDomain: "estevents.firebaseapp.com",
      databaseURL: "https://estevents-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "estevents",
      storageBucket: "estevents.firebasestorage.app",
      messagingSenderId: "227576344701",
      appId: "1:227576344701:web:adf679a530b4ce72d5c114",
      measurementId: "G-3ZDEP57KXF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let lastAdded = null;
    let lastAddedData = null;

    // ‚úÖ –î–æ–¥–∞–≤–∞–Ω–Ω—è –≥—ñ–º–Ω–∞—Å—Ç–∫–∏ (–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–º –æ–≤–µ—Ä–ª–µ—î–º)
    window.addGymnast = async function() {
      const name = document.getElementById("name").value.trim();
      const club = document.getElementById("club").value.trim();
      const event = document.getElementById("event").value;
      const score = parseFloat(document.getElementById("score").value.replace(",", "."));

      if (!name || !club || !event || isNaN(score)) {
        alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ!");
        return;
      }

      const gymnastKey = name.replace(/\s+/g, "_");
      const gymnastRef = ref(db, "gymnasts/" + gymnastKey);

      const snapshot = await new Promise(resolve => {
        onValue(gymnastRef, resolve, { onlyOnce: true });
      });

      const oldData = snapshot.val() || {};
      const updatedData = {
        name,
        club,
        –û–±—Ä—É—á: oldData.–û–±—Ä—É—á || 0,
        "–ú‚Äô—è—á": oldData["–ú‚Äô—è—á"] || 0,
        –ë—É–ª–∞–≤–∏: oldData.–ë—É–ª–∞–≤–∏ || 0,
        –°—Ç—Ä—ñ—á–∫–∞: oldData.–°—Ç—Ä—ñ—á–∫–∞ || 0,
      };

      updatedData[event] = score;
      updatedData.suma =
        (updatedData.–û–±—Ä—É—á || 0) +
        (updatedData["–ú‚Äô—è—á"] || 0) +
        (updatedData.–ë—É–ª–∞–≤–∏ || 0) +
        (updatedData.–°—Ç—Ä—ñ—á–∫–∞ || 0);

      await set(gymnastRef, updatedData);

      // üü° –°–∏–≥–Ω–∞–ª –¥–ª—è –≤—Å—ñ—Ö ‚Äî –ø–æ–∫–∞–∑–∞—Ç–∏ –æ–≤–µ—Ä–ª–µ–π
      await set(ref(db, "displayOverlay"), {
        name,
        club,
        event,
        score,
        gymnastKey,
        time: Date.now()
      });

      lastAdded = gymnastKey;
      lastAddedData = { name, club, event, score };

      document.getElementById("name").value = "";
      document.getElementById("club").value = "";
      document.getElementById("score").value = "";
    };

    // ‚úÖ –ü–æ–∫–∞–∑ –æ–≤–µ—Ä–ª–µ—é
    function showNewGymnastOverlay(name, club, event, score, gymnastKey) {
      const overlay = document.getElementById("newGymnastOverlay");
      const content = document.getElementById("overlayContent");
      content.innerHTML = `
        <h1>${name}</h1>
        <h2>${club}</h2>
        <h3>${event.toUpperCase()}</h3>
        <div class="score">${score.toFixed(3)}</div>
      `;
      overlay.classList.add("visible");

      // üîÑ –ß–µ—Ä–µ–∑ 15 —Å–µ–∫ ‚Äî –∞–Ω—ñ–º–∞—Ü—ñ—è –∑–º–µ–Ω—à–µ–Ω–Ω—è —ñ "–≤—Å—Ç–∞–≤–∞–Ω–Ω—è" —É —Ç–∞–±–ª–∏—Ü—é
      setTimeout(() => {
        overlay.classList.add("shrinking");
        setTimeout(() => {
          overlay.classList.remove("visible", "shrinking");
          // üí´ –ü—ñ–¥—Å–≤—ñ—á—É—î–º–æ –æ—Å—Ç–∞–Ω–Ω—é —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∫—É –≤ —Ç–∞–±–ª–∏—Ü—ñ
          const row = document.querySelector(`tr[data-key="${gymnastKey}"]`);
          if (row) {
            row.classList.add("just-added");
            setTimeout(() => row.classList.remove("just-added"), 6000);
          }
        }, 2500);
      }, 15000);
    }

    // ‚úÖ –°–ª—É—Ö–∞—î–º–æ —Å–∏–≥–Ω–∞–ª
    onValue(ref(db, "displayOverlay"), snapshot => {
      const data = snapshot.val();
      if (!data) return;
      const lastTime = window._lastOverlayTime || 0;
      if (data.time > lastTime) {
        window._lastOverlayTime = data.time;
        showNewGymnastOverlay(data.name, data.club, data.event, data.score, data.gymnastKey);
        setTimeout(() => remove(ref(db, "displayOverlay")), 19000);
      }
    });

    window.clearAll = async function() {
      if (confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø–æ–≤–Ω—ñ—Å—Ç—é –æ—á–∏—Å—Ç–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é?")) {
        const gymnastsRef = ref(db, "gymnasts");
        await set(gymnastsRef, {});
        alert("–¢–∞–±–ª–∏—Ü—é –æ—á–∏—â–µ–Ω–æ!");
      }
    };

    window.deleteGymnast = async function(nameKey) {
      if (confirm("–í–∏–¥–∞–ª–∏—Ç–∏ " + nameKey.replace(/_/g, " ") + "?")) {
        const gymnastRef = ref(db, "gymnasts/" + nameKey);
        await remove(gymnastRef);
      }
    };

    window.togglePanel = function() {
      const panel = document.getElementById("editPanel");
      panel.classList.toggle("visible");
    };

    // ‚úÖ –¢–∞–±–ª–∏—Ü—è
    const tableContainer = document.getElementById("tablesWrapper");
    onValue(ref(db, "gymnasts"), snapshot => {
      const data = snapshot.val() || {};
      const arr = Object.entries(data)
        .map(([key, val]) => ({ key, ...val }))
        .sort((a, b) => b.suma - a.suma);

      tableContainer.innerHTML = "";
      const chunkSize = 20;
      const chunks = [];
      for (let i = 0; i < arr.length; i += chunkSize) {
        chunks.push(arr.slice(i, i + chunkSize));
      }

      chunks.forEach((group, index) => {
        const table = document.createElement("table");
        table.classList.add("subTable");
        table.innerHTML = `
          <thead>
            <tr>
              <th>–ú—ñ—Å—Ü–µ</th>
              <th>–Ü–º‚Äô—è</th>
              <th>–ö–ª—É–±</th>
              <th>–û–±—Ä—É—á</th>
              <th>–ú‚Äô—è—á</th>
              <th>–ë—É–ª–∞–≤–∏</th>
              <th>–°—Ç—Ä—ñ—á–∫–∞</th>
              <th>–°—É–º–∞</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector("tbody");

        group.forEach((g, i) => {
          const row = document.createElement("tr");
          row.dataset.key = g.key; // üëà –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–ª—è –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è
          const crown = (i + index * chunkSize) === 0 ? "üëë" : "";
          row.innerHTML = `
            <td>${i + 1 + index * chunkSize}</td>
            <td class="${(i + index * chunkSize) === 0 ? 'shine' : ''}">${crown} ${g.name}</td>
            <td>${g.club}</td>
            <td>${g.–û–±—Ä—É—á || "-"}</td>
            <td>${g["–ú‚Äô—è—á"] || "-"}</td>
            <td>${g.–ë—É–ª–∞–≤–∏ || "-"}</td>
            <td>${g.–°—Ç—Ä—ñ—á–∫–∞ || "-"}</td>
            <td><b>${(g.suma || 0).toFixed(3)}</b></td>
            <td><button class="delete-btn" onclick="deleteGymnast('${g.key}')">üçÅ</button></td>
          `;
          tbody.appendChild(row);
        });

        tableContainer.appendChild(table);
      });
    });
  </script>

  <style>
    body { background-color:#0d0d0d;color:#f6c453;font-family:"Segoe UI",sans-serif;overflow:hidden;margin:0; }
    h1 { text-align:center;color:#f6c453;text-shadow:0 0 20px #f6c453;margin-top:10px; }
    #tablesWrapper { width:100%;display:flex;justify-content:center;gap:20px;flex-wrap:nowrap; }
    .subTable { border-collapse:collapse;background:rgba(30,30,30,0.9);border-radius:14px;box-shadow:0 0 20px rgba(246,196,83,0.3); }
    th,td { padding:6px 8px;text-align:center;color:#f6c453;white-space:nowrap; }
    th { background-color:#1e1e1e;border-bottom:2px solid #f6c453; }

    /* ‚ú® –ü—ñ–¥—Å–≤—ñ—á–µ–Ω–Ω—è –æ—Å—Ç–∞–Ω–Ω—å–æ—ó —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∫–∏ */
    .just-added {
      background: radial-gradient(circle at center, rgba(255,215,0,0.3), transparent 70%);
      animation: pulseRow 1.5s ease-in-out infinite alternate;
    }
    @keyframes pulseRow {
      from { background-color: rgba(255,215,0,0.25); }
      to { background-color: rgba(255,215,0,0.05); }
    }

    /* üü° –û–≤–µ—Ä–ª–µ–π */
    #newGymnastOverlay {
      position:fixed;inset:0;background:rgba(0,0,0,0.95);
      display:flex;justify-content:center;align-items:center;
      color:#f6c453;flex-direction:column;text-align:center;
      opacity:0;pointer-events:none;transition:opacity 1s ease;
      z-index:100;
    }
    #newGymnastOverlay.visible { opacity:1;pointer-events:all; }
    #newGymnastOverlay.shrinking {
      animation: shrinkToTable 2.5s ease-in forwards;
    }
    @keyframes shrinkToTable {
      0% { transform: scale(1); opacity: 1; }
      80% { transform: scale(0.3); opacity: 0.6; }
      100% { transform: scale(0); opacity: 0; }
    }

    #newGymnastOverlay h1 { font-size:5vw;margin:10px 0; }
    #newGymnastOverlay h2 { font-size:3vw;margin:5px 0;color:#ffd700; }
    #newGymnastOverlay h3 { font-size:2.5vw;margin:5px 0;color:#fff; }
    #newGymnastOverlay .score {
      font-size:6vw;color:#fff799;text-shadow:0 0 20px #ffd700;
    }
  </style>
</head>

<body>
  <h1>–ó–æ–ª–æ—Ç–∞ –û—Å—ñ–Ω—å 2025 üçÅ</h1>
  <div id="tablesWrapper"></div>
  <button style="position:fixed; bottom:10px; right:10px; z-index:30;" onclick="togglePanel()">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ üõ†Ô∏è</button>
  <div id="editPanel">
    <input type="text" id="name" placeholder="–Ü–º‚Äô—è">
    <input type="text" id="club" placeholder="–ö–ª—É–±">
    <select id="event">
      <option value="–û–±—Ä—É—á">–û–±—Ä—É—á</option>
      <option value="–ú‚Äô—è—á">–ú‚Äô—è—á</option>
      <option value="–ë—É–ª–∞–≤–∏">–ë—É–ª–∞–≤–∏</option>
      <option value="–°—Ç—Ä—ñ—á–∫–∞">–°—Ç—Ä—ñ—á–∫–∞</option>
    </select>
    <input type="text" id="score" placeholder="–û—Ü—ñ–Ω–∫–∞ (27.650)">
    <button onclick="addGymnast()">–î–æ–¥–∞—Ç–∏</button>
    <button onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é</button>
  </div>

  <div id="newGymnastOverlay">
    <div id="overlayContent"></div>
  </div>
</body>
</html>
