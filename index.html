<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDBXt2gMo92d6MpzxdzEvLI8UMcyHipVTg",
    authDomain: "estevents.firebaseapp.com",
    databaseURL: "https://estevents-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "estevents",
    storageBucket: "estevents.firebasestorage.app",
    messagingSenderId: "227576344701",
    appId: "1:227576344701:web:adf679a530b4ce72d5c114",
    measurementId: "G-3ZDEP57KXF"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let lastAdded = null; // üëâ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —ñ–º‚Äô—è –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –¥–æ–¥–∞–Ω–æ—ó –≥—ñ–º–Ω–∞—Å—Ç–∫–∏

  // –î–æ–¥–∞–≤–∞–Ω–Ω—è –≥—ñ–º–Ω–∞—Å—Ç–∫–∏
  window.addGymnast = async function() {
    const name = document.getElementById("name").value.trim();
    const club = document.getElementById("club").value.trim();
    const event = document.getElementById("event").value;
    const score = parseFloat(document.getElementById("score").value.replace(",", "."));

    if (!name || !club || !event || isNaN(score)) {
      alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ!");
      return;
    }

    const gymnastKey = name.replace(/\s+/g, "_");
    const gymnastRef = ref(db, "gymnasts/" + gymnastKey);
    const snapshot = await new Promise(resolve => {
      onValue(gymnastRef, resolve, { onlyOnce: true });
    });

    let data = snapshot.val() || { name, club, obruƒç: 0, myach: 0, bu≈Çavy: 0, strichka: 0, suma: 0 };
    data[event] = score;
    data.suma = (data.obruƒç || 0) + (data.myach || 0) + (data.bu≈Çavy || 0) + (data.strichka || 0);
    await set(gymnastRef, data);

    lastAdded = gymnastKey; // üëâ –∑–∞–ø–∞–º‚Äô—è—Ç–∞–ª–∏ –æ—Å—Ç–∞–Ω–Ω—é –¥–æ–¥–∞–Ω—É

    document.getElementById("name").value = "";
    document.getElementById("club").value = "";
    document.getElementById("score").value = "";
  };

  // –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ
  window.clearAll = async function() {
    if (confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø–æ–≤–Ω—ñ—Å—Ç—é –æ—á–∏—Å—Ç–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é?")) {
      const gymnastsRef = ref(db, "gymnasts");
      await set(gymnastsRef, {});
      alert("–¢–∞–±–ª–∏—Ü—é –æ—á–∏—â–µ–Ω–æ!");
    }
  };

  // –í–∏–¥–∞–ª–µ–Ω–Ω—è –≥—ñ–º–Ω–∞—Å—Ç–∫–∏
  window.deleteGymnast = async function(nameKey) {
    if (confirm("–í–∏–¥–∞–ª–∏—Ç–∏ " + nameKey.replace(/_/g, " ") + "?")) {
      const gymnastRef = ref(db, "gymnasts/" + nameKey);
      await remove(gymnastRef);
    }
  };

  // –ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ –ø–∞–Ω–µ–ª—å —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
  window.togglePanel = function() {
    const panel = document.getElementById("editPanel");
    panel.classList.toggle("visible");
  };

  // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ
  const tableBody = document.getElementById("gymnastTable");

  onValue(ref(db, "gymnasts"), snapshot => {
    const data = snapshot.val() || {};
    const arr = Object.entries(data)
      .map(([key, val]) => ({ key, ...val }))
      .sort((a, b) => b.suma - a.suma);

    tableBody.innerHTML = "";
    arr.forEach((g, i) => {
      const row = document.createElement("tr");
      const crown = i === 0 ? "üëë" : "";

      // —è–∫—â–æ —Ü–µ –æ—Å—Ç–∞–Ω–Ω—è –¥–æ–¥–∞–Ω–∞ ‚Äî –¥–æ–¥–∞—Ç–∏ –∞–Ω—ñ–º–∞—Ü—ñ—é
      if (g.key === lastAdded) {
        row.classList.add("new-gymnast");
        setTimeout(() => row.classList.remove("new-gymnast"), 4000);
      }

      row.innerHTML = `
        <td>${i + 1}</td>
        <td class="${i === 0 ? 'shine' : ''}">${crown} ${g.name}</td>
        <td>${g.club}</td>
        <td>${g.obruƒç || "-"}</td>
        <td>${g.myach || "-"}</td>
        <td>${g.bu≈Çavy || "-"}</td>
        <td>${g.strichka || "-"}</td>
        <td><b>${g.suma.toFixed(3)}</b></td>
        <td><button class="delete-btn" onclick="deleteGymnast('${g.key}')">üçÅ</button></td>
      `;
      tableBody.appendChild(row);
    });

    // –ê–≤—Ç–æ–º–∞—Å—à—Ç–∞–± —Ç–∞–±–ª–∏—Ü—ñ
    const mainTable = document.getElementById("mainTable");
    const scale = Math.min(1, 10 / (arr.length / 6));
    mainTable.style.transform = `scale(${scale})`;
  });

  // –ê–Ω—ñ–º–∞—Ü—ñ—è –ª–∏—Å—Ç–∫—ñ–≤ üçÅ
  function createLeaf() {
    const leaf = document.createElement("div");
    leaf.classList.add("leaf");
    leaf.textContent = "üçÅ";
    leaf.style.left = Math.random() * 100 + "vw";
    leaf.style.animationDuration = 5 + Math.random() * 10 + "s";
    leaf.style.fontSize = 20 + Math.random() * 20 + "px";
    document.body.appendChild(leaf);
    setTimeout(() => leaf.remove(), 15000);
  }
  setInterval(createLeaf, 500);
</script>

<style>
/* –∑–∞–ª–∏—à–µ–Ω–æ –≤—Å–µ —è–∫ –±—É–ª–æ, –ª–∏—à–µ –¥–æ–¥–∞–Ω–æ –¥–≤–∞ –Ω–æ–≤—ñ —Å—Ç–∏–ª—ñ –Ω–∏–∂—á–µ ‚¨áÔ∏è */

/* --- –Ω–æ–≤–∞ –≥—ñ–º–Ω–∞—Å—Ç–∫–∞ –ø–ª–∞–≤–Ω–æ –∑‚Äô—è–≤–ª—è—î—Ç—å—Å—è –∑–Ω–∏–∑—É --- */
.new-gymnast {
  animation: fadeInUp 1.2s ease-out, blink 1.2s 3 ease-in-out;
}

@keyframes fadeInUp {
  from {
    transform: translateY(60px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

/* --- –º–µ—Ä–µ—Ö—Ç—ñ–Ω–Ω—è –¥–ª—è –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –¥–æ–¥–∞–Ω–æ—ó --- */
@keyframes blink {
  0%, 100% { background-color: rgba(246,196,83,0.1); }
  50% { background-color: rgba(246,196,83,0.4); }
}
</style>
