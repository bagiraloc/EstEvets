<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ó–æ–ª–æ—Ç–∞ –û—Å—ñ–Ω—å 2025 üçÅ</title>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDBXt2gMo92d6MpzxdzEvLI8UMcyHipVTg",
    authDomain: "estevents.firebaseapp.com",
    databaseURL: "https://estevents-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "estevents",
    storageBucket: "estevents.firebasestorage.app",
    messagingSenderId: "227576344701",
    appId: "1:227576344701:web:adf679a530b4ce72d5c114",
    measurementId: "G-3ZDEP57KXF"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let lastAdded = null;
  let lastAddedData = null;

  // --- üîÅ –ê–í–¢–û–ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –ó GOOGLE –¢–ê–ë–õ–ò–¶–Ü ---
  const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSiLPa8xQDMN2XwhllLfVcFo_fjbLYVU0nQ6iSVTaAJezovC8OYgSgTOqiz-muYLNnYAtgJhqpZwhPK/pub?gid=910619786&single=true&output=csv";

  let lastSheetData = "";

  async function fetchSheetData() {
    try {
      const res = await fetch(sheetURL);
      const text = await res.text();
      const rows = text.split("\n").map(r => r.split(","));
      const d7 = rows[6][3]?.trim(); // D7 - —ñ–º‚Äô—è
      const e7 = rows[6][4]?.trim(); // E7 - –∫–ª—É–±
      const g7 = rows[6][6]?.trim(); // G7 - –≤–∏–¥
      const h7 = parseFloat(rows[6][7]?.replace(",", "."));
      if (!d7 || !e7 || !g7 || isNaN(h7)) return;

      const current = `${d7}|${e7}|${g7}|${h7}`;
      if (current === lastSheetData) return; // —è–∫—â–æ —Ç—ñ —Å–∞–º—ñ –¥–∞–Ω—ñ ‚Äî –Ω–µ –æ–Ω–æ–≤–ª—é—î–º–æ
      lastSheetData = current;

      const gymnastKey = d7.replace(/\s+/g, "_");
      const gymnastRef = ref(db, "gymnasts/" + gymnastKey);
      const snapshot = await new Promise(resolve => {
        onValue(gymnastRef, resolve, { onlyOnce: true });
      });

      let data = snapshot.val() || { name: d7, club: e7, –û–±—Ä—É—á: 0, "–ú‚Äô—è—á": 0, –ë—É–ª–∞–≤–∏: 0, –°—Ç—Ä—ñ—á–∫–∞: 0, suma: 0 };
      data[g7] = h7;
      data.suma = (data.–û–±—Ä—É—á || 0) + (data["–ú‚Äô—è—á"] || 0) + (data.–ë—É–ª–∞–≤–∏ || 0) + (data.–°—Ç—Ä—ñ—á–∫–∞ || 0);
      await set(gymnastRef, data);

      console.log("–û–Ω–æ–≤–ª–µ–Ω–æ –∑ —Ç–∞–±–ª–∏—Ü—ñ:", d7, g7, h7);
    } catch (err) {
      console.error("–ü–æ–º–∏–ª–∫–∞ –∑—á–∏—Ç—É–≤–∞–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ:", err);
    }
  }

  setInterval(fetchSheetData, 3000); // –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 3 —Å–µ–∫—É–Ω–¥–∏
  // --- üîÅ –ö–Ü–ù–ï–¶–¨ –ê–í–¢–û–ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø ---

  // –î–æ–¥–∞–≤–∞–Ω–Ω—è –≥—ñ–º–Ω–∞—Å—Ç–∫–∏ –≤—Ä—É—á–Ω—É
  window.addGymnast = async function() {
    const name = document.getElementById("name").value.trim();
    const club = document.getElementById("club").value.trim();
    const event = document.getElementById("event").value;
    const score = parseFloat(document.getElementById("score").value.replace(",", "."));
    if (!name || !club || !event || isNaN(score)) {
      alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ!");
      return;
    }
    const gymnastKey = name.replace(/\s+/g, "_");
    const gymnastRef = ref(db, "gymnasts/" + gymnastKey);
    const snapshot = await new Promise(resolve => {
      onValue(gymnastRef, resolve, { onlyOnce: true });
    });
    let data = snapshot.val() || { name, club, –û–±—Ä—É—á: 0, "–ú‚Äô—è—á": 0, –ë—É–ª–∞–≤–∏: 0, –°—Ç—Ä—ñ—á–∫–∞: 0, suma: 0 };
    data[event] = score;
    data.suma = (data.–û–±—Ä—É—á || 0) + (data["–ú‚Äô—è—á"] || 0) + (data.–ë—É–ª–∞–≤–∏ || 0) + (data.–°—Ç—Ä—ñ—á–∫–∞ || 0);
    await set(gymnastRef, data);
  };

  // –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ
  window.clearAll = async function() {
    if (confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø–æ–≤–Ω—ñ—Å—Ç—é –æ—á–∏—Å—Ç–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é?")) {
      const gymnastsRef = ref(db, "gymnasts");
      await set(gymnastsRef, {});
      alert("–¢–∞–±–ª–∏—Ü—é –æ—á–∏—â–µ–Ω–æ!");
    }
  };

  // –í–∏–¥–∞–ª–µ–Ω–Ω—è –≥—ñ–º–Ω–∞—Å—Ç–∫–∏
  window.deleteGymnast = async function(nameKey) {
    if (confirm("–í–∏–¥–∞–ª–∏—Ç–∏ " + nameKey.replace(/_/g, " ") + "?")) {
      const gymnastRef = ref(db, "gymnasts/" + nameKey);
      await remove(gymnastRef);
    }
  };

  // –ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ –ø–∞–Ω–µ–ª—å —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
  window.togglePanel = function() {
    const panel = document.getElementById("editPanel");
    panel.classList.toggle("visible");
  };

  // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å
  const tableContainer = document.getElementById("tablesWrapper");
  onValue(ref(db, "gymnasts"), snapshot => {
    const data = snapshot.val() || {};
    const arr = Object.entries(data)
      .map(([key, val]) => ({ key, ...val }))
      .sort((a, b) => b.suma - a.suma);
    tableContainer.innerHTML = "";
    const chunkSize = 20;
    const chunks = [];
    for (let i = 0; i < arr.length; i += chunkSize) {
      chunks.push(arr.slice(i, i + chunkSize));
    }
    chunks.forEach((group, index) => {
      const table = document.createElement("table");
      table.classList.add("subTable");
      table.innerHTML = `
        <thead>
          <tr>
            <th>–ú—ñ—Å—Ü–µ</th>
            <th>–Ü–º‚Äô—è</th>
            <th>–ö–ª—É–±</th>
            <th>–û–±—Ä—É—á</th>
            <th>–ú‚Äô—è—á</th>
            <th>–ë—É–ª–∞–≤–∏</th>
            <th>–°—Ç—Ä—ñ—á–∫–∞</th>
            <th>–°—É–º–∞</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector("tbody");
      group.forEach((g, i) => {
        const row = document.createElement("tr");
        const crown = (i + index * chunkSize) === 0 ? "üëë" : "";
        row.innerHTML = `
          <td>${i + 1 + index * chunkSize}</td>
          <td>${crown} ${g.name}</td>
          <td>${g.club}</td>
          <td>${g.–û–±—Ä—É—á || "-"}</td>
          <td>${g["–ú‚Äô—è—á"] || "-"}</td>
          <td>${g.–ë—É–ª–∞–≤–∏ || "-"}</td>
          <td>${g.–°—Ç—Ä—ñ—á–∫–∞ || "-"}</td>
          <td><b>${g.suma.toFixed(3)}</b></td>
          <td><button class="delete-btn" onclick="deleteGymnast('${g.key}')">üçÅ</button></td>
        `;
        tbody.appendChild(row);
      });
      tableContainer.appendChild(table);
    });
  });
</script>

<style>
/* —Ç–≤—ñ–π —Å—Ç–∏–ª—å –∑–∞–ª–∏—à–∏–≤—Å—è –±–µ–∑ –∑–º—ñ–Ω */
body {
  background-color: #0d0d0d;
  color: #f6c453;
  font-family: "Segoe UI", sans-serif;
  overflow: hidden;
  margin: 0;
}
</style>
</head>

<body>
  <h1>–ó–æ–ª–æ—Ç–∞ –û—Å—ñ–Ω—å 2025 üçÅ</h1>
  <div id="tablesWrapper"></div>
  <button style="position:fixed; bottom:10px; right:10px; z-index:30;" onclick="togglePanel()">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ üõ†Ô∏è</button>
  <div id="editPanel">
    <input type="text" id="name" placeholder="–Ü–º‚Äô—è">
    <input type="text" id="club" placeholder="–ö–ª—É–±">
    <select id="event">
      <option value="–û–±—Ä—É—á">–û–±—Ä—É—á</option>
      <option value="–ú‚Äô—è—á">–ú‚Äô—è—á</option>
      <option value="–ë—É–ª–∞–≤–∏">–ë—É–ª–∞–≤–∏</option>
      <option value="–°—Ç—Ä—ñ—á–∫–∞">–°—Ç—Ä—ñ—á–∫–∞</option>
    </select>
    <input type="text" id="score" placeholder="–û—Ü—ñ–Ω–∫–∞ (27.650)">
    <button onclick="addGymnast()">–î–æ–¥–∞—Ç–∏</button>
    <button onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é</button>
  </div>
</body>
</html>
